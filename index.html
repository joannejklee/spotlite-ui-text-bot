<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spotlite UI Text Bot</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .container {
      background:#fff; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.1);
      padding:32px; width:100%; max-width:800px;
    }
    .header { text-align:center; margin-bottom:24px; }
    .logo { font-size:24px; font-weight:700; color:#333; margin-bottom:6px; }
    .subtitle { color:#666; font-size:14px; }

    .form-group { margin-bottom:20px; }
    .form-row { display:flex; gap:16px; margin-bottom:20px; }
    label { display:block; font-weight:600; color:#333; margin-bottom:8px; font-size:14px; }

    textarea, select {
      width:100%; padding:12px 14px; border:2px solid #e1e5e9; border-radius:8px; font-size:14px; font-family:inherit;
      transition:border-color .2s; background:#fff;
    }
    textarea { min-height:120px; resize:vertical; }
    textarea:focus, select:focus { outline:none; border-color:#667eea; }

    .btn {
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:none;
      padding:14px 28px; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%;
      transition:transform .2s, box-shadow .2s;
    }
    .btn:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 10px 20px rgba(102,126,234,.3); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .output-section { margin-top:24px; }
    .output-box {
      background:#f8f9fa; border:2px solid #e1e5e9; border-radius:8px; padding:16px; min-height:80px;
      font-size:14px; line-height:1.5; margin-bottom:12px; white-space:pre-wrap;
    }
    .output-box.has-content { background:#fff; border-color:#28a745; }

    .notes-box {
      background:#fff3cd; border:2px solid #ffeaa7; border-radius:8px; padding:12px; font-size:13px; line-height:1.5;
      color:#5c4700; white-space:pre-wrap;
    }
    .notes-box:empty { display:none; }

    .status { text-align:center; padding:12px; border-radius:8px; font-size:14px; margin-bottom:16px; }
    .status.warning { background:#fff3cd; border:1px solid #ffeaa7; color:#856404; }
    .status.error { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }

    .meta-info {
      background:#e9ecef; border-radius:6px; padding:12px; font-size:12px; color:#495057; margin-top:12px; display:none;
    }
    .meta-row { display:flex; justify-content:space-between; gap:12px; margin-bottom:4px; }
    .replacements { margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
    .chip { background:#d4edda; color:#1f5132; border-radius:14px; padding:4px 8px; font-size:11px; }

    .toolbar { display:flex; gap:8px; margin-top:8px; }
    .clip { background:#eef2ff; border:1px solid #c7d2fe; color:#333; font-weight:600; padding:8px 10px; border-radius:8px; cursor:pointer; }
    .clip:active { transform:scale(.98); }

    @media (max-width: 600px) { .form-row { flex-direction:column; gap:12px; } .container { padding:24px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">Spotlite UI Text Bot</div>
      <div class="subtitle">Polish & translate UI copy with deterministic rules</div>
    </div>

    <form id="textForm">
      <div class="form-group">
        <label for="inputText">Input Text</label>
        <textarea id="inputText" name="inputText" placeholder="Enter your UI text here..." required></textarea>
      </div>

      <div class="form-row">
        <div style="flex:1;">
          <label for="targetLang">Target Language</label>
          <select id="targetLang" name="targetLang">
            <option value="auto">Auto-detect</option>
            <option value="ko">Korean</option>
            <option value="en">English</option>
          </select>
        </div>
        <div style="flex:1;">
          <label for="component">Component Type</label>
          <select id="component" name="component">
            <option value="freeform">Loading components...</option>
          </select>
        </div>
      </div>

      <button type="submit" class="btn" id="submitBtn">Polish Text</button>
    </form>

    <div class="output-section">
      <div class="form-group">
        <label>Processed Text</label>
        <div id="outputBox" class="output-box">Results will appear here...</div>
        <div class="toolbar">
          <button id="copyBtn" type="button" class="clip" title="Copy result">Copy</button>
          <button id="clearBtn" type="button" class="clip" title="Clear">Clear</button>
        </div>
        <div id="notesBox" class="notes-box"></div>
        <div id="metaInfo" class="meta-info"></div>
      </div>
    </div>
  </div>

  <script>
    // Your deployed GAS Web App URL:
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzkJX_dr-beCstZbRbCBefR7Ek9D0kdM28Si-4cdAvqwsgs5m0Vz2OLjohIWq0jksmj/exec';

    let isLoading = false;
    const $ = (id) => document.getElementById(id);

    document.addEventListener('DOMContentLoaded', () => {
      loadMetadata();
      $('textForm').addEventListener('submit', handleSubmit);
      $('copyBtn').addEventListener('click', copyOutput);
      $('clearBtn').addEventListener('click', clearAll);
    });

    async function loadMetadata() {
      try {
        const res = await fetch(`${GAS_URL}?meta=1&t=${Date.now()}`); // cache buster
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        if (data.ok && Array.isArray(data.components) && data.components.length) {
          populateComponents(data.components);
          // show backend disclaimers if any
          if (Array.isArray(data.disclaimers) && data.disclaimers.length) {
            showWarning('⚠️ Meta disclaimers:\n- ' + data.disclaimers.join('\n- '));
          }
        } else {
          showWarning('⚠️ Using default components - unable to load from sheet');
          populateComponents(['button','toast','placeholder','freeform']);
        }
      } catch (err) {
        console.error('Failed to load metadata:', err);
        showWarning('⚠️ Using default components - connection failed');
        populateComponents(['button','toast','placeholder','freeform']);
      }
    }

    function populateComponents(components) {
      const select = $('component');
      select.innerHTML = '';
      if (!components.includes('freeform')) components.unshift('freeform');
      components.forEach(comp => {
        const opt = document.createElement('option');
        opt.value = comp; opt.textContent = comp;
        select.appendChild(opt);
      });
    }

    async function handleSubmit(e) {
      e.preventDefault();
      if (isLoading) return;

      const text = ($('inputText').value || '').trim();
      if (!text) { showError('Please enter some text to process'); return; }

      const payload = {
        text,
        targetLang: $('targetLang').value,
        component: $('component').value
      };

      setLoading(true);
      clearOutput();

      try {
        // Avoid preflight: no custom headers, form-encoded body
        const body = new URLSearchParams({ q: JSON.stringify(payload) });
        const res = await fetch(GAS_URL, { method: 'POST', body });
        const data = await res.json();

        if (data.ok) displaySuccess(data);
        else displayError(data);

      } catch (err) {
        console.error('Request failed:', err);
        showError('Connection failed. Check GAS URL and deployment access.');
      } finally {
        setLoading(false);
      }
    }

    function displaySuccess(data) {
      const outputBox = $('outputBox');
      const notesBox = $('notesBox');
      const metaInfo = $('metaInfo');

      outputBox.textContent = data.text || 'Please verify against the style guide.';
      outputBox.classList.add('has-content');

      const notes = [];
      if (Array.isArray(data.issues) && data.issues.length) {
        notes.push('Issues:\n- ' + data.issues.join('\n- '));
      }
      if (Array.isArray(data.disclaimers) && data.disclaimers.length) {
        notes.push('Disclaimers:\n- ' + data.disclaimers.join('\n- '));
      }
      notesBox.textContent = notes.join('\n\n');

      renderMeta(data.meta, metaInfo);
    }

    function displayError(data) {
      const outputBox = $('outputBox');
      const notesBox = $('notesBox');
      const metaInfo = $('metaInfo');

      const errText = data.text || 'Error processing request';
      outputBox.textContent = `❌ ${data.error || 'Processing failed'}${data.detail ? (': ' + data.detail) : ''}\n\n${errText}`;
      outputBox.classList.remove('has-content');

      const lines = [];
      if (data.error) lines.push('Error: ' + data.error);
      if (Array.isArray(data.issues) && data.issues.length) lines.push('Issues: ' + data.issues.join(', '));
      if (Array.isArray(data.disclaimers) && data.disclaimers.length) lines.push('Disclaimers: ' + data.disclaimers.join(' '));
      notesBox.textContent = lines.join('\n');

      renderMeta(data.meta, metaInfo);
    }

    function renderMeta(meta, container) {
      if (!meta) { container.style.display = 'none'; return; }
      let html = '';
      html += row('Source', meta.sourceLang);
      html += row('Target', meta.targetLang);
      html += row('Component', meta.component);
      if (Array.isArray(meta.steps) && meta.steps.length) {
        html += row('Steps', meta.steps.join(', '));
      }
      if (Array.isArray(meta.replacements) && meta.replacements.length) {
        html += `<div class="replacements">` +
          meta.replacements.map(r => {
            // Support both our shape {from,to,priority} and Claude’s {original,replacement}
            const from = r.from || r.original || '';
            const to = r.to || r.replacement || '';
            const p = (r.priority !== undefined) ? ` (prio ${r.priority})` : '';
            return `<span class="chip">${escapeHtml(from)} → ${escapeHtml(to)}${p}</span>`;
          }).join(' ') + `</div>`;
      }
      container.innerHTML = html;
      container.style.display = 'block';
    }

    function row(k, v){ return `<div class="meta-row"><span>${escapeHtml(String(k))}</span><span>${escapeHtml(String(v||''))}</span></div>`; }

    function setLoading(b) {
      isLoading = b;
      const btn = $('submitBtn');
      btn.disabled = b;
      btn.textContent = b ? 'Processing...' : 'Polish Text';
    }

    function showWarning(msg){ showStatus(msg,'warning'); }
    function showError(msg){ showStatus(msg,'error'); }
    function showStatus(message, type) {
      const existing = document.querySelector('.status');
      if (existing) existing.remove();
      const el = document.createElement('div');
      el.className = `status ${type}`;
      el.textContent = message;
      const form = $('textForm');
      form.insertBefore(el, form.firstChild);
      setTimeout(()=>{ if (el.parentNode) el.remove(); }, 5000);
    }

    function clearOutput() {
      $('outputBox').textContent = 'Processing...';
      $('outputBox').classList.remove('has-content');
      $('notesBox').textContent = '';
      $('metaInfo').style.display = 'none';
    }

    function clearAll() {
      $('inputText').value = '';
      clearOutput();
    }

    async function copyOutput() {
      const text = $('outputBox').textContent || '';
      if (!text.trim()) { showWarning('Nothing to copy'); return; }
      try {
        await navigator.clipboard.writeText(text);
        showWarning('Copied to clipboard');
      } catch { showWarning('Copy failed'); }
    }

    // Basic HTML escaping for meta chips
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>
